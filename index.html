<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مغامرة البطل - 30 مرحلة</title>
    <style>
        body { margin: 0; overflow: hidden; background: #5c94fa; font-family: 'Arial', sans-serif; touch-action: none; }
        #gameCanvas { display: block; }
        .ui { position: fixed; top: 15px; left: 15px; color: white; font-size: 22px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        .controls { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; }
        .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.4); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; color: white; user-select: none; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:active { background: rgba(255,255,255,0.6); transform: scale(0.9); }
    </style>
</head>
<body>

<div class="ui">المرحلة: <span id="lvl">1</span> / 30</div>
<canvas id="gameCanvas"></canvas>

<div class="controls">
    <div style="display:flex; gap:15px;">
        <div class="btn" id="leftBtn">⬅</div>
        <div class="btn" id="rightBtn">➡</div>
    </div>
    <div class="btn" id="jumpBtn">⬆</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- نظام الصوت البرمجي (بدون روابط) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, duration, vol=0.1) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
    osc.stop(audioCtx.currentTime + duration);
}

const jumpSnd = () => { playSound(400, 'square', 0.15); playSound(600, 'square', 0.2); };
const winSnd = () => { playSound(523, 'triangle', 0.1); setTimeout(()=>playSound(659, 'triangle', 0.1), 100); setTimeout(()=>playSound(783, 'triangle', 0.3), 200); };

// --- متغيرات اللعبة ---
let currentLevel = parseInt(localStorage.getItem('hero_game_lvl')) || 1;
document.getElementById('lvl').innerText = currentLevel;

const player = {
    x: 50, y: 0, w: 35, h: 35,
    color: '#E74C3C', dy: 0, speed: 6,
    jumpPower: 14, grounded: false, moveLeft: false, moveRight: false
};

const gravity = 0.7;
let platforms = [];
let goal = { x: 0, y: 0, w: 45, h: 70 };

function createLevel(lvl) {
    platforms = [
        { x: 0, y: canvas.height - 40, w: canvas.width * 2, h: 40, c: '#27AE60' } // الأرض
    ];
    
    // توزيع منصات عشوائي ذكي بناءً على المرحلة
    for(let i=1; i<6; i++) {
        platforms.push({
            x: i * 250, 
            y: canvas.height - (100 + Math.random() * 200),
            w: 120, h: 20, c: '#8E44AD'
        });
    }
    
    goal.x = 1600 + (lvl * 100);
    goal.y = canvas.height - 110;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // الخلفية (تتحرك مع اللاعب)
    ctx.save();
    ctx.translate(-player.x + 50, 0);

    // رسم الهدف (العلم الذهبي)
    ctx.fillStyle = '#F1C40F';
    ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
    ctx.fillStyle = '#fff';
    ctx.fillRect(goal.x, goal.y, 10, goal.h);

    // رسم المنصات
    platforms.forEach(p => {
        ctx.fillStyle = p.c;
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.strokeStyle = 'rgba(0,0,0,0.1)';
        ctx.strokeRect(p.x, p.y, p.w, p.h);
    });

    // رسم اللاعب
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.w, player.h);
    ctx.strokeStyle = '#fff';
    ctx.strokeRect(player.x, player.y, player.w, player.h);

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

function update() {
    if (player.moveLeft) player.x -= player.speed;
    if (player.moveRight) player.x += player.speed;

    player.y += player.dy;
    if (player.y + player.h < canvas.height) {
        player.dy += gravity;
        player.grounded = false;
    } else {
        player.dy = 0; player.y = canvas.height - player.h - 40; player.grounded = true;
    }

    platforms.forEach(p => {
        if (player.x < p.x + p.w && player.x + player.w > p.x &&
            player.y + player.h > p.y && player.y + player.h < p.y + p.h + player.dy) {
            player.dy = 0; player.y = p.y - player.h; player.grounded = true;
        }
    });

    if (player.x + player.w > goal.x && player.y + player.h > goal.y) {
        winSound();
        currentLevel++;
        if(currentLevel > 30) { alert("ختمت اللعبة!"); currentLevel = 1; }
        localStorage.setItem('hero_game_lvl', currentLevel);
        document.getElementById('lvl').innerText = currentLevel;
        player.x = 50; createLevel(currentLevel);
    }
}

// التحكم
const startAudio = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); };

document.getElementById('leftBtn').ontouchstart = (e) => { e.preventDefault(); player.moveLeft = true; startAudio(); };
document.getElementById('leftBtn').ontouchend = () => player.moveLeft = false;

document.getElementById('rightBtn').ontouchstart = (e) => { e.preventDefault(); player.moveRight = true; startAudio(); };
document.getElementById('rightBtn').ontouchend = () => player.moveRight = false;

document.getElementById('jumpBtn').ontouchstart = (e) => { 
    e.preventDefault();
    if(player.grounded) { player.dy = -player.jumpPower; jumpSnd(); }
    startAudio();
};

createLevel(currentLevel);
draw();
</script>
</body>
</html>
