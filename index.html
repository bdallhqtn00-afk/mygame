<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>ماريو: مغامرة الـ 30 مرحلة</title>
    <style>
        body { margin: 0; overflow: hidden; background: #5c94fa; touch-action: none; font-family: sans-serif; }
        canvas { display: block; }
        .ui { position: fixed; top: 10px; left: 10px; color: white; font-size: 18px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        
        /* تعديل الأزرار لتكون أصغر (Mini Controls) */
        .controls { position: fixed; bottom: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; box-sizing: border-box; }
        .btn { 
            width: 55px; height: 55px; /* تم تصغير الحجم من 70 إلى 55 */
            background: rgba(0,0,0,0.35); 
            border: 2px solid rgba(255,255,255,0.6); 
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            color: white; font-size: 22px; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .a-btn { 
            background: rgba(255, 49, 49, 0.5); 
            border-color: #fff; 
            width: 65px; height: 65px; /* زر القفز أكبر قليلاً من الحركة لكنه أصغر من السابق */
            font-size: 24px;
        }
        .btn:active { background: rgba(255,255,255,0.5); transform: scale(0.9); }
    </style>
</head>
<body>

<div class="ui">المرحلة: <span id="lvl">1</span> / 30</div>
<canvas id="gameCanvas"></canvas>

<div class="controls">
    <div style="display:flex; gap:12px;">
        <div class="btn" id="lBtn">◀</div>
        <div class="btn" id="rBtn">▶</div>
    </div>
    <div class="btn a-btn" id="jBtn">A</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let currentLvl = parseInt(localStorage.getItem('mario_lvl')) || 1;
let player = { x: 50, y: 100, w: 32, h: 40, velX: 0, velY: 0, grounded: false, dead: false };
let platforms = [], enemies = [], cameraX = 0, goalX = 0;

function initLevel(lvl) {
    document.getElementById('lvl').innerText = lvl;
    player.x = 50; player.y = 100; player.dead = false;
    cameraX = 0;
    
    const worldLength = 2000 + (lvl * 500);
    platforms = [{ x: 0, y: canvas.height - 40, w: worldLength, h: 40, type: 'ground' }];
    
    for(let i=1; i < 5 + lvl; i++) {
        platforms.push({ x: i * 300, y: canvas.height - 150 - (Math.random() * 150), w: 100, h: 30, type: 'brick' });
        enemies.push({ x: i * 450, y: canvas.height - 75, w: 35, h: 35, speed: -2 - (lvl * 0.2) });
    }
    
    goalX = worldLength - 100;
}

function update() {
    if (player.dead) return;
    if (keys.r) player.velX = 5; else if (keys.l) player.velX = -5; else player.velX *= 0.8;
    player.velY += 0.8; player.x += player.velX; player.y += player.velY;

    player.grounded = false;
    platforms.forEach(p => {
        if (player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h > p.y && player.y < p.y + p.h) {
            if (player.velY > 0 && player.y + player.h < p.y + 20) {
                player.velY = 0; player.y = p.y - player.h; player.grounded = true;
            } else if (player.velY < 0 && player.y > p.y + p.h - 20) {
                player.velY = 2; player.y = p.y + p.h;
            }
        }
    });

    enemies.forEach(en => {
        en.x += en.speed;
        if (en.x < 0 || en.x > goalX) en.speed *= -1;
        if (player.x < en.x + en.w && player.x + player.w > en.x && player.y + player.h > en.y && player.y < en.y + en.h) {
            if (player.velY > 0) { en.dead = true; player.velY = -10; }
            else { player.dead = true; setTimeout(() => initLevel(currentLvl), 1000); }
        }
    });
    enemies = enemies.filter(en => !en.dead);

    if (player.x > goalX) {
        if (currentLvl < 30) {
            currentLvl++;
            localStorage.setItem('mario_lvl', currentLvl);
            alert("مبروك! إلى المرحلة " + currentLvl);
            initLevel(currentLvl);
        } else {
            alert("أنت بطل حقيقي! ختمت اللعبة!");
            currentLvl = 1; initLevel(1);
        }
    }

    if (player.x > canvas.width / 2) cameraX = player.x - canvas.width / 2;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save(); ctx.translate(-cameraX, 0);

    ctx.fillStyle = "gold"; ctx.fillRect(goalX, canvas.height - 240, 50, 200);
    ctx.fillStyle = "white"; ctx.fillRect(goalX, canvas.height - 240, 5, 200);

    platforms.forEach(p => {
        ctx.fillStyle = p.type === 'ground' ? "#8B4513" : "#ff5a5a";
        ctx.fillRect(p.x, p.y, p.w, p.h);
    });

    enemies.forEach(en => { ctx.fillStyle = "black"; ctx.fillRect(en.x, en.y, en.w, en.h); });

    ctx.fillStyle = player.dead ? "gray" : "red";
    ctx.fillRect(player.x, player.y, player.w, player.h);

    ctx.restore(); update(); requestAnimationFrame(draw);
}

let keys = {l: false, r: false};
document.getElementById('lBtn').addEventListener('touchstart', (e) => { e.preventDefault(); keys.l = true; });
document.getElementById('lBtn').addEventListener('touchend', (e) => { e.preventDefault(); keys.l = false; });
document.getElementById('rBtn').addEventListener('touchstart', (e) => { e.preventDefault(); keys.r = true; });
document.getElementById('rBtn').addEventListener('touchend', (e) => { e.preventDefault(); keys.r = false; });
document.getElementById('jBtn').addEventListener('touchstart', (e) => { e.preventDefault(); if (player.grounded) player.velY = -16; });

initLevel(currentLvl); draw();
</script>
</body>
</html>
